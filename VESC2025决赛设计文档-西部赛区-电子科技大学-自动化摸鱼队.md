2025 芯原杯全国嵌入式软件开发大赛－设计文档

# 2025 芯原杯 <br> 全国嵌入式软件开发大赛 

## 1. 设计文档

芯原微电子（上海）股份有限公司

2025 芯原杯全国嵌入式软件开发大赛－设计文档

团队名称：自动化摸鱼队
联系邮箱：shu＿xy714＠qq．com
联系电话： 17761458707
日 期：2025．07．24

## 2. 文档修订历史

本节记录文档版本修订历史。
注：本文档不需要对每个补丁或次要修订进行更新。本文档中的内容在一系列的修订中趋于稳定。

| 版本 | 日期 | 作者 | 说明 |
| :--- | :--- | :--- | :--- |
|  |  |  |  |
|  |  |  |  |

## 3. 目录

文档修订历史 ..... 3
目录。 ..... 4
1．概述 ..... 5
2．方案介绍 ..... 6
3．算法设计． ..... 7
4．软件工作流程 ..... 8
5．验证及测试结果 ..... 10
6．团队介绍及分工 ..... 11

## 4. 1．概述

本项目在 RISC－V 嵌入式开发板上实现了人声检测和说话人识别功能，涵盖 PDM 读取、音频播放、模型运行、蓝牙收发等功能模块，所有功能测试正常，无明显BUG；

算法部分，使用 MFCC 进行特征提取；设计、训练并量化部署了 int8 类型的 CNN，分别用于人声检测、说话人识别，人声检测模型的测试集准确率为 $x x x$ ，说话人识别模型的测试集准确率为 $x x x$ 。所有模型都经过了量化、裁剪设计，能够在开发板上实时运行，正确识别。

嵌入式部分，使用环形缓冲区实现安全且高效的语音 PCM 数据内存管理；使用 SDK 的 Event System API 实现多任务管理与任务间消息传输；使用 NMSIS－DSP 库实现并加速 MFCC 计算，使用 NMSIS－NN库提供的 API 实现在开发板上进行卷积和池化计算，最终在开发板上实现了实时人声检测和说话人识别，算法更新频率为 1 秒。系统所有功能均按题目要求实现，且进行了 10 分钟以上的稳定运行测试。

蓝牙部分，定义了蓝牙 GATT Service；使用 App 写入 Control 和 Rwa＿Data 的特征值实现开关；创建 ble＿task＿app 注册监听事件并循环监听；创建 ble＿task＿event＿handler 实现算法处理结果打印；创建 bt＿speech＿set＿raw＿data＿value 去 Notify 原始音频数据；基于原始数据包格式文件创建包头实现对原始数据封装和 CRC－8 数据校验。最终在 APP 上实现了 BLE 数据传输的完整性、验证了开始／结束音频播放及正确性、实现了算法处理与原始数据发送同时工作。此外，使用 iOS 手机 App 持续测试了 30分钟原始数据发送，实际采样率始终稳定在 8000 SPS 附近，准确率一直为 $100 \%$ ，验证了蓝牙的长时数据传输的稳定性。在使用新版本的 App 后，对原始数据开关测试了 20 次，均可以稳定完整播放数据，蓝牙的循环稳定性非常好。

## 5. 2．方案介绍

3．算法设计

## 6. 4．软件工作流程

系统上电并完成初始化后，分别创建多个 task，各 task 各自完成自己负责的功能。
1．创建 audio＿task 用来初始化 i2s 和 codec，随后注册 Event，等待其它 Task 发送请求播放音频 Event；为避免在 audio＿task 的回调函数中直接操作 i 2 s 和 codec，在回调函数中仅设置标志位，实际播放函数在 audio＿task 的主循环中进行；
2．创建 algo＿task，注册两个 Event 用来分别监听来自 speech＿task 的 PCM 数据就绪消息和来自 ble＿task 的算法运行开关消息；随后初始化 mfcc 并 malloc 相关缓冲区（这些缓冲区会一直使用，故仅在 algo＿task 中分配一次，后续不再释放），随后在主循环中监听 Event；
3．创建 speech＿task 用来初始化 PDM 并注册 PDM 中断回调函数，在回调函数中将 PDM 中断数据存入环形缓冲区中，并判断缓冲区中的数据累积是否超过 1 秒，若超过 1 秒则向 algo＿task 发送数据就绪 Event；
4．创建 ble＿task，同样注册两个 Event 用来监听来自 algo＿task 的打印识别结果消息和发送原始数据消息；编写 BLE 相关回调函数并与定义的 BLE GATT Service 绑定；由于原始数据发送功能较为耗时，为避免直接在 ble 的 task 回调函数中进行原始数据发送，同样只在回调函数中设置标志位，实际的原始数据发送在 ble＿task 的主循环中进行；

## 7. 高效安全的语音数据内存管理：

为了实现安全且高效的 PCM 数据内存管理，使用了环形缓冲区 RingBuffer 来存储语音数据， RingBuffer 由静态分配的全局数组和一个读索引、一个写索引组成，长度为 32001byte，可以存储 2秒的 PCM 数据。当 RingBuffer 数据存满时，会自动覆盖最前面的数据，而不会造成数据溢出；

## 8. 系统工作流程：

系统上电后创建以上 task 并完成初始化，此时 PDM 开始工作，系统不断在 PDM 的中断回调函数中将 PCM 数据保存到 RingBuffer，并在 RingBuffer 数据存储量大于 2000byte（ 0.125 秒）时向algo＿task发数据就绪消息，通知algo＿task 处理数据；
algo＿task 收到数据就绪消息后，将 RingBuffer 中的数据取出并存放在另一个静态数组中，随后判断是否启动了原始数据发送功能和算法识别功能，若启动了原始数据发送功能则发送 Event 给 ble＿task，由 ble＿task 完成原始数据发送功能；若启动了算法识别功能则分别运行 mfcc、人声检测、其他说话人识别、目标说话人识别模型，并将识别结果通过 Event 发送给 ble 进行蓝牙发送；

当手机 APP 上启动原始音频发送功能后，开发板的 GATT Service 注册的回调函数触发，使能系统的原始数据发送标志位，并在 ble＿task 的主循环中完成原始音频数据发送；
当手机 APP 上启动算法识别功能后，同样开发板的 GATT Service 注册的回调函数出发，在回调函数中发送启动算法处理 Event，由 algo＿task 的回调函数接收该 Event 并启动算法处理；

算法处理主要包括 4 大部分，第一部分调用 NMSIS－DSP 库的 API 实现 float 格式的 MFCC 计算；第二部分调用 NMSIS－NN 库提供的卷积、池化等函数进行二分类 VAD 人声检测，若检测结果为非人声，则向 ble＿task 发送打印非人声识别结果消息并退出算法处理函数，若检测结果为人声，则进行第三部分计算；第三部分同样使用 NMSIS－NN 库进行二分类其他说话人识别，若识别结果为其他人，则向 ble＿task 发送打印其他人识别结果消息并退出算法处理函数，若识别结果为目标说话人，则进行第四部分计算；第四部分运行向量嵌入模型，并调用 NMSIS－DSP 库实现结果向量与目标向量的相似度计算，并将相似度最大的结果作为最终识别结果向 ble＿task 发送消息。

2025 芯原杯全国嵌入式软件开发大赛－设计文档

我们绘制了系统创建的所有 task 及它们之间相互通信的 Event 流向，如下图所示
![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-09.jpg?height=389&width=1512&top_left_y=331&top_left_x=306)

我们绘制了系统的整体工作流程图，如下图所示：
![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-09.jpg?height=1177&width=1514&top_left_y=802&top_left_x=308)

## 9. 5．验证及测试结果

蓝牙部分：验证及测试结果如下，左一及左二为 iOS 手机 VESCApp 按下原始数据发送开关后，持续测试了 30 分钟，实际采样率始终稳定在 8000 SPS 附近，跳动范围小，准确率一直为 $100 \%$ ，验证了蓝牙长时原始数据传输的稳定性。开始／结束音频播放及正确性验证无误，对接收到的原始数据进行了播放，验证了 BLE 数据传输的完整性。左三图为语音原始数据与算法处理同时开启的截图显示，可以看到功能运行正常。

| 14：29 | ：：！！ 5 G Z4 | 15：00 |  | ：：：！5G 62 | 15：00 1 |  | ：：日！ 56 6 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
|  | VeriHealthi |  | VeriHealthi | ![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-10.jpg?height=32&width=72&top_left_y=809&top_left_x=1246) |  | VeriHealthi | ![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-10.jpg?height=31&width=70&top_left_y=805&top_left_x=1725) |
|  | BLE信号：10．．． | BLE信号：80．．． <br> VHR－0030 |  |  |  |  |  |
| 实时数据 |  | 实时数据 |  |  |  |  |  |
| 14：29 29＇无人声 |  | 14：59 44＇ <br> 说话人：其它说话人 |  |  |  |  |  |
| 14：29 28＇ |  | 14：59 43＇ <br> 说话人：其它说话人 |  |  |  |  |  |
|  |  | BLE信号：10．．． <br> VHR－0030 |  |  |  |  |  |
| 14：29 27＇无人声 |  |  |  |  |  |  |  |
| 14：29 26＇ |  | 14：59 41＇ |  |  | 实时数据 |  |  |
|  |  | 说话人：其它说话人 |  |  |  |  |  |
| 14：29 25＇无人声 |  | 14：59 40＇ |  |  | 15：00 27＇无人声 |  |  |
|  |  | 无人声 <br> 4 A．En つの |  |  |  |  |  |
| 原始数据发送 | ![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-10.jpg?height=46&width=76&top_left_y=1393&top_left_x=707) | 原始数据发送 | ![](https://cdn.mathpix.com/cropped/2025_07_23_25d6f004fdb5bdcbb7a7g-10.jpg?height=92&width=434&top_left_y=1354&top_left_x=869) | 1 | 15：00 26＇无人声 |  |  |
|  |  |  |  |  | 15：00 25＇无人声 |  |  |
| 语音原始数据 | 100000 | 语音原始数据 | 29210400 | Bytes | 15：00 24＇无人声 |  |  |
|  |  |  |  |  |  |  |  |
| 实际采样率 | 8013.5 | 实际采样率 | 7921．6 SPS |  | 15：00 23＇ <br> 无人声 |  |  |
| 准确率 | 100 \％ | 准确率 <br> 100 \％ |  |  | 原始数据发送 <br> 语音原始数据 <br> 29517000 <br> Bytes |  |  |
| 回放语音原始数据 | － | 回放语音原始数据 <br> $\triangleright$ |  |  |  |  |  |

## 10. 6．团队介绍及分工

我们是自动化摸鱼队，来自西部赛区－电子科技大学自动化工程学院，年级都是研二，都是同一间教研室的同门，我们的团队分工情况如下：

| 姓名 | 单位 | 年级 | 分工 |
| :--- | :--- | :--- | :--- |
| 舒星研（队长） | 电子科技大学自动化工程学院 | 研二 | 嵌入式软件开发、模型部署 |
| 李东吴 | 电子科技大学自动化工程学院 | 研二 | 算法设计、模型训练、量化和部署 |
| 张含 | 电子科技大学自动化工程学院 | 研二 | BLE 蓝牙协议开发 |

